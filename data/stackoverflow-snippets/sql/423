WITH VIEWS AS (
select VIDEO_ID, VIEWS , ratings, rating,LOAD_DATE , 
       ROW_NUMBER () OVER (PARTITION BY VIDEO_ID ORDER BY LOAD_DATE DESC) RN,
ROW_NUMBER () OVER (PARTITION BY VIDEO_ID ORDER BY LOAD_DATE ASC) RN_ASC
from video_pit
)
, LATEST_UPLOAD AS (
SELECT VIDEO_ID, VIEWS , ratings, rating
FROM VIEWS
WHERE RN=1
)
, SECOND_LATEST_UPLOAD AS (
SELECT VIDEO_ID, VIEWS
FROM VIEWS
WHERE RN=2
)
, FIRST_UPLOAD AS (
SELECT VIDEO_ID, VIEWS
FROM VIEWS
WHERE RN_ASC=1
)
SELECT * FROM (
SELECT 
L.VIDEO_ID, 
L.VIEWS , 
L.ratings, 
L.rating,
L.VIEWS - S.VIEWS as change_since_last_upload,
L.VIEWS - F.VIEWS as change_since_first_upload
FROM LATEST_UPLOAD as L
INNER JOIN SECOND_LATEST_UPLOAD as S ON L.VIDEO_ID=S.VIDEO_ID
INNER JOIN FIRST_UPLOAD as F ON L.VIDEO_ID=F.VIDEO_ID
ORDER BY change_since_last_upload DESC) WHERE ROWNUM <=10
